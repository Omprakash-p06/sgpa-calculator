<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Engineering SGPA Calculator</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1976d2;
            --primary-dark: #115293;
            --accent: #43a047;
            --danger: #d32f2f;
            --bg: #f5f7fa;
            --card-bg: #fff;
            --border: #e0e3e7;
            --shadow: 0 2px 8px 0 rgba(25, 118, 210, 0.08);
            --radius: 12px;
            --transition: 0.18s cubic-bezier(.4,2,.6,1);
        }
        html {
            scroll-behavior: smooth;
        }
        body {
            background: var(--bg);
            min-height: 100vh;
            font-family: 'Inter', 'Roboto', 'Segoe UI', Arial, sans-serif;
            color: #212b36;
            margin: 0;
            padding: 0;
        }
        .main-layout {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        header {
            background: var(--primary);
            color: #fff;
            padding: 40px 0 20px 0;
            text-align: center;
            box-shadow: 0 2px 8px rgba(25, 118, 210, 0.08);
            border-bottom-left-radius: var(--radius);
            border-bottom-right-radius: var(--radius);
            position: relative;
        }
        header h1 {
            font-size: 2.3rem;
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }
        header p {
            font-size: 1.08rem;
            color: #e3eaf2;
            max-width: 700px;
            margin: 0 auto;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 28px 8px 18px 8px;
            flex: 1;
        }
        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 20px 18px 16px 18px;
            margin-bottom: 24px;
            border: 1px solid var(--border);
            transition: box-shadow 0.18s, transform 0.12s, border-color 0.12s, background 0.18s;
            position: relative;
        }
        .card:hover {
            transform: translateY(-1px) scale(1.01);
            box-shadow: 0 4px 16px rgba(25, 118, 210, 0.13);
            border-color: var(--primary);
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 14px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
            background: none;
            color: var(--primary-dark);
            border-radius: 8px 8px 0 0;
            box-shadow: none;
        }
        .card-title {
            font-size: 1.15rem;
            color: var(--primary-dark);
            font-weight: 700;
            margin: 0;
            letter-spacing: 0.3px;
        }
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }
        .input-group input, 
        .input-group select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            background: #f8f9fa;
            transition: all var(--transition);
            box-sizing: border-box;
        }
        .input-group input:focus, 
        .input-group select:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 95, 236, 0.15);
            background-color: #fff;
        }
        .btn {
            background: var(--primary);
            color: #fff;
            border: none;
            padding: 9px 18px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.98rem;
            font-weight: 700;
            transition: all var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 7px;
            box-shadow: 0 1px 2px rgba(25,118,210,0.10);
            letter-spacing: 0.3px;
        }
        .btn:hover, .btn:focus {
            background: var(--primary-dark);
            transform: translateY(-1px) scale(1.01);
            box-shadow: 0 2px 6px rgba(25,118,210,0.13);
        }
        .btn.secondary {
            background: #f5f7fa;
            color: var(--primary-dark);
            border: 1px solid var(--primary);
            box-shadow: none;
        }
        .btn.secondary:hover {
            background: #e3eaf2;
            color: var(--primary-dark);
            border-color: var(--primary-dark);
        }
        .table-responsive {
            margin: -16px 0;
        }
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin: 10px 0;
            background: #fff;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 4px rgba(25,118,210,0.04);
        }
        th, td {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
            transition: background 0.12s, color 0.12s;
            font-size: 0.98em;
        }
        th {
            background-color: #f5f7fa;
            color: #1976d2;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.95rem;
            letter-spacing: 0.5px;
        }
        tr:last-child td {
            border-bottom: none;
        }
        tr:hover td {
            background-color: #e3eaf2;
        }
        .editable-cell {
            cursor: pointer;
            border-radius: 5px;
            transition: background 0.12s, box-shadow 0.12s;
        }
        .editable-cell:hover, .editable-cell:focus {
            background: #e3eaf2;
            box-shadow: 0 0 0 2px var(--primary);
        }
        .inline-edit-input, .inline-edit-select {
            width: 90%;
            padding: 5px 8px;
            font-size: 1em;
            border: 1px solid var(--primary);
            border-radius: 5px;
            outline: none;
            background: #fff;
            color: #212b36;
            box-shadow: 0 1px 2px rgba(25,118,210,0.07);
            transition: border 0.12s;
        }
        .inline-edit-input:focus, .inline-edit-select:focus {
            border: 2px solid var(--primary-dark);
        }
        .sgpa-formula {
            margin-top: 10px;
            font-size: 0.98rem;
            color: var(--primary-dark);
            background: #f5f7fa;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid var(--border);
            box-shadow: 0 1px 2px rgba(25,118,210,0.04);
        }
        .sgpa-formula .formula-note {
            display: block;
            font-size: 0.91em;
            color: var(--primary);
            margin-top: 3px;
        }
        @media (max-width: 768px) {
            .container { padding: 6px 2px; }
            .card { padding: 6px 2px; }
            .card-header { flex-direction: column; align-items: flex-start; gap: 6px; padding-bottom: 4px; }
            th, td { padding: 6px; font-size: 0.96em; }
            .btn, .btn.secondary { padding: 7px 8px; font-size: 0.96em; }
            .grade-chip { padding: 3px 7px; font-size: 0.93em; }
        }
        
        /* Modal Styles */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1001; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }
        .modal-content {
            background: #fff;
            margin: 10% auto;
            padding: 0;
            border: 1px solid var(--primary);
            width: 92%;
            max-width: 480px;
            border-radius: var(--radius);
            box-shadow: 0 4px 16px rgba(25,118,210,0.13);
            animation: slideIn 0.18s;
        }
        .modal-header {
            padding: 10px 16px;
            background: var(--primary);
            color: #fff;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top-left-radius: var(--radius);
            border-top-right-radius: var(--radius);
        }
        .modal-header h2 { margin: 0; font-size: 1.08rem; }
        .modal-body { padding: 14px; display: flex; flex-direction: column; gap: 8px; }
        .close-btn {
            color: #fff;
            float: right;
            font-size: 20px;
            font-weight: bold;
            background: none;
            border: none;
            cursor: pointer;
            opacity: 0.85;
            transition: opacity var(--transition);
        }
        .close-btn:hover { opacity: 1; }
        @keyframes fadeIn { from {opacity: 0} to {opacity: 1} }
        @keyframes slideIn { from {transform: translateY(-50px)} to {transform: translateY(0)} }
        
        /* Tabs Styles */
        .tools-section { margin-top: 24px; }
        .tabs {
            display: flex;
            gap: 4px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 20px;
        }
        .tab-link {
            padding: 12px 20px;
            cursor: pointer;
            border: none;
            background-color: transparent;
            font-size: 1.05rem;
            font-weight: 600;
            color: #6c757d;
            border-bottom: 3px solid transparent;
            transition: all var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .tab-link:hover {
            color: var(--primary);
            background-color: #f8f9fa;
        }
        .tab-link.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }
        .tab-content { display: none; animation: fadeIn 0.5s; }
        
        .tool-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: flex-end;
            margin-bottom: 20px;
        }
         .tool-controls .input-group {
            flex: 1 1 auto;
            min-width: 120px;
        }
        .tool-result { margin-top: 20px; }
        .tool-description { color: #6c757d; font-size: 1rem; margin: -8px 0 16px 0; }
        .sgpa-result-box {
            background: #f5f7fa;
            color: var(--primary-dark);
            border-radius: 6px;
            border: 1px solid var(--primary);
            box-shadow: 0 1px 2px rgba(25,118,210,0.07);
            padding: 10px 12px;
            font-size: 1em;
            margin-top: 8px;
        }

        /* Grade Chip Styles */
        .grade-chips-row {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 7px;
        }
        .grade-chip {
            display: inline-flex;
            align-items: center;
            background: #f5f7fa;
            border-radius: 999px;
            padding: 5px 12px;
            font-size: 0.95rem;
            font-weight: 600;
            border: 1px solid var(--primary);
            transition: all var(--transition);
            box-shadow: 0 1px 2px rgba(25,118,210,0.06);
        }
        .chip-label {
            color: var(--primary-dark);
            font-weight: 700;
            margin-right: 6px;
        }
        .chip-grade {
            font-weight: 800;
            padding: 3px 8px;
            border-radius: 999px;
            font-size: 0.93rem;
            color: #fff;
        }
        .chip-grade.O { background-color: #43a047; }
        .chip-grade.Aplus { background-color: #1976d2; }
        .chip-grade.A { background-color: #115293; }
        .chip-grade.Bplus { background-color: #f59e42; }
        .chip-grade.B { background-color: #fde047; color: #212b36; }
        .chip-grade.C { background-color: #fbbf24; }
        .chip-grade.P { background-color: #a78bfa; }
        .chip-grade.F { background-color: #d32f2f; }
        @media (max-width: 600px) {
            .container {
                padding: 12px 2px;
            }
            .card {
                padding: 10px;
            }
            .card-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
                padding-bottom: 8px;
            }
            th, td {
                padding: 8px;
                font-size: 0.98em;
            }
            .btn, .btn.secondary {
                padding: 10px 12px;
                font-size: 0.98em;
            }
            .grade-chip {
                padding: 6px 8px;
                font-size: 0.92em;
            }
        }
        /* Dark mode styles */
        body.dark-mode {
            background: #181e29;
            color: #e0e3e7;
        }
        body.dark-mode .card {
            background: #232a36;
            color: #e0e3e7;
            border-color: #232a36;
            box-shadow: 0 2px 8px 0 rgba(25, 118, 210, 0.13);
        }
        body.dark-mode .card-header {
            background: none;
            color: #90caf9;
        }
        body.dark-mode .card-title, body.dark-mode th {
            color: #fff;
        }
        body.dark-mode table {
            background: #232a36;
            color: #e0e3e7;
        }
        body.dark-mode th {
            background-color: #1e293b;
            color: #fff;
        }
        body.dark-mode th, body.dark-mode td {
            border-bottom: 1px solid #334155;
        }
        body.dark-mode tr:hover td {
            background-color: #1e293b;
        }
        body.dark-mode .editable-cell:hover, body.dark-mode .editable-cell:focus {
            background: #334155;
            box-shadow: 0 0 0 2px #1976d2;
        }
        body.dark-mode .inline-edit-input, body.dark-mode .inline-edit-select {
            background: #232a36;
            color: #e0e3e7;
            border: 1px solid #1976d2;
        }
        body.dark-mode .inline-edit-input:focus, body.dark-mode .inline-edit-select:focus {
            border: 2px solid #90caf9;
        }
        body.dark-mode .btn {
            background: #1976d2;
            color: #fff;
        }
        body.dark-mode .btn.secondary {
            background: #334155;
            color: #90caf9;
            border: 1px solid #1976d2;
        }
        body.dark-mode .btn.secondary:hover {
            background: #232a36;
            color: #fff;
            border-color: #90caf9;
        }
        body.dark-mode .sgpa-formula {
            background: #232a36;
            color: #90caf9;
            border-color: #334155;
        }
        body.dark-mode .grade-chip {
            background: #334155;
            border-color: #1976d2;
            color: #e0e3e7;
        }
        body.dark-mode .chip-label {
            color: #90caf9;
        }
        body.dark-mode .chip-grade.O { background-color: #43a047; color: #fff; }
        body.dark-mode .chip-grade.Aplus { background-color: #1976d2; color: #fff; }
        body.dark-mode .chip-grade.A { background-color: #115293; color: #fff; }
        body.dark-mode .chip-grade.Bplus { background-color: #f59e42; color: #232a36; }
        body.dark-mode .chip-grade.B { background-color: #fde047; color: #232a36; }
        body.dark-mode .chip-grade.C { background-color: #fbbf24; color: #232a36; }
        body.dark-mode .chip-grade.P { background-color: #a78bfa; color: #fff; }
        body.dark-mode .chip-grade.F { background-color: #d32f2f; color: #fff; }
        body.dark-mode .sgpa-result-box {
            background: #232a36;
            color: #90caf9;
            border: 1px solid #1976d2;
        }
        body.dark-mode .modal-content {
            background: #232a36;
            color: #e0e3e7;
            border-color: #1976d2;
            box-shadow: 0 4px 16px rgba(25,118,210,0.13);
        }
        body.dark-mode .modal-header {
            background: none;
            color: #90caf9;
        }
        body.dark-mode .notification {
            background: #23242b;
            color: #e3e6eb;
            border: 1px solid #35384a;
            box-shadow: 0 2px 8px rgba(0,0,0,0.18);
        }
        body.dark-mode #darkModeToggle {
            background: linear-gradient(90deg, #23242b 0%, #2d3a4a 100%);
            color: #7bb6ff;
            border: 1px solid #35384a;
        }
        body.dark-mode #darkModeToggle:hover {
            background: #1a1b22;
            color: #fff;
            border-color: #7bb6ff;
        }
    </style>
</head>
<body>
<div class="main-layout">
    <header>
        <h1><i class="fas fa-graduation-cap"></i> Engineering SGPA Calculator</h1>
        <p>A smart tool to plan your semester, simulate results, and achieve your desired SGPA.</p>
        <div style="margin-top:18px; display:flex; justify-content:center; gap:12px; flex-wrap:wrap;">
            <a href="https://github.com/Omprakash-p06/sgpa-calculator" target="_blank" rel="noopener" class="btn secondary" style="display:inline-flex;align-items:center;gap:8px;font-size:1em;">
                <i class="fab fa-github"></i> GitHub
            </a>
            <button id="darkModeToggle" class="btn secondary" style="display:inline-flex;align-items:center;gap:8px;font-size:1em;">
                <i class="fas fa-moon"></i> <span id="darkModeText">Dark Mode</span>
            </button>
        </div>
    </header>
    <div class="container">
        <!-- Main Subjects Card -->
        <div class="card" id="main-card">
            <div class="card-header">
                <div class="card-title"><i class="fas fa-list"></i> My Semester Subjects</div>
                <button id="openAddSubjectModalBtn" class="btn"><i class="fas fa-plus"></i> Add New Subject</button>
            </div>
            <div class="table-responsive">
                <table id="subjectsTable">
                    <thead>
                        <tr>
                            <th>Subject Name</th>
                            <th>Credits</th>
                            <th>Internal Marks</th>
                            <th>Desired Grade</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="subjectsTableBody">
                        <!-- Subjects will be added here dynamically -->
                    </tbody>
                </table>
            </div>

            <!-- Tools Section -->
            <div class="tools-section">
                <div class="tabs">
                    <button class="tab-link active" onclick="openTool(event, 'GradePlanner')"><i class="fas fa-bullseye"></i> Grade Planner</button>
                    <button class="tab-link" onclick="openTool(event, 'SEESimulator')"><i class="fas fa-calculator"></i> SEE Simulator</button>
                </div>

                <!-- Grade Planner Tab -->
                <div id="GradePlanner" class="tab-content" style="display: block;">
                    <div class="tool-controls">
                         <div class="input-group">
                            <label for="desiredSGPA">Desired SGPA</label>
                            <input type="number" id="desiredSGPA" min="0" max="10" step="0.01" placeholder="e.g., 8.5" value="8.0">
                        </div>
                        <button id="suggestGradesBtn" class="btn secondary"><i class="fas fa-lightbulb"></i> Suggest Grades</button>
                        <button id="calculateMarksBtn" class="btn secondary"><i class="fas fa-tasks"></i> Required SEE Marks</button>
                        <button id="calcSGPAFromDesiredGrades" class="btn secondary"><i class="fas fa-star"></i> SGPA from Desired</button>
                    </div>
                    <div id="marksResults" class="tool-result"></div>
                    <div id="gradeSuggestions" class="tool-result"></div>
                    <div id="desiredGradesSGPAresult" class="tool-result sgpa-result-box" style="display:none;"></div>
                </div>

                <!-- SEE Simulator Tab -->
                <div id="SEESimulator" class="tab-content">
                    <p class="tool-description">Enter your expected SEE marks for each subject to calculate your final SGPA.</p>
                     <div class="table-responsive">
                        <table id="seeSimTable">
                            <thead>
                                <tr>
                                    <th>Subject Name</th>
                                    <th>Credits</th>
                                    <th>Internal Marks</th>
                                    <th>SEE Marks</th>
                                    <th>Total (100)</th>
                                </tr>
                            </thead>
                            <tbody id="seeSimTableBody">
                                <!-- SEE simulation rows -->
                            </tbody>
                        </table>
                    </div>
                    <div class="tool-controls" style="margin-top: 16px;">
                        <button id="calcSGPAFromSEE" class="btn"><i class="fas fa-equals"></i> Calculate SGPA</button>
                    </div>
                    <div id="sgpaSEEresult" class="tool-result sgpa-result-box" style="display:none;"></div>
                </div>
            </div>
        </div>

        <!-- Grade Info Card -->
        <div class="card" id="grade-info-card">
            <div class="card-title"><i class="fas fa-info-circle"></i> Grade System Info</div>
             <div class="grade-chips-row">
                <div class="grade-chip"><span class="chip-label">O</span><span class="chip-grade O">90-100</span></div>
                <div class="grade-chip"><span class="chip-label">A+</span><span class="chip-grade Aplus">80-89</span></div>
                <div class="grade-chip"><span class="chip-label">A</span><span class="chip-grade A">70-79</span></div>
                <div class="grade-chip"><span class="chip-label">B+</span><span class="chip-grade Bplus">60-69</span></div>
                <div class="grade-chip"><span class="chip-label">B</span><span class="chip-grade B">50-59</span></div>
                <div class="grade-chip"><span class="chip-label">C</span><span class="chip-grade C">45-49</span></div>
                <div class="grade-chip"><span class="chip-label">P</span><span class="chip-grade P">40-44</span></div>
                <div class="grade-chip"><span class="chip-label">F</span><span class="chip-grade F">&lt;40</span></div>
            </div>
            <div class="sgpa-formula">
                <b>SGPA Formula:</b> <span>SGPA = 10 - Σ[(0.05 × credits) × n]</span>
                <span class="formula-note">n is based on grade (O:0, A+:1, A:2, B+:3, B:4, C:5, P:6, F:10)</span>
            </div>
        </div>
    </div>
    <footer>
        <p></p>
    </footer>
</div>

<!-- Add Subject Modal -->
<div id="addSubjectModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-plus-circle"></i> Add New Subject</h2>
            <button id="closeModalBtn" class="close-btn">&times;</button>
        </div>
        <div class="modal-body">
            <form id="subjectForm" autocomplete="off">
                <div class="input-group">
                    <label for="subjectName">Subject Name</label>
                    <input type="text" id="subjectName" placeholder="e.g., Engineering Mathematics" required>
                </div>
                <div class="input-group">
                    <label for="subjectCredits">Credits</label>
                    <input type="number" id="subjectCredits" min="1" max="5" placeholder="e.g., 4" required>
                </div>
                <div class="input-group">
                    <label for="internalMarks">Internal Marks (out of 50)</label>
                    <input type="number" id="internalMarks" min="0" max="50" placeholder="e.g., 38" required>
                </div>
                <div class="input-group">
                    <label for="desiredGrade">Desired Grade (Optional)</label>
                    <select id="desiredGrade">
                        <option value="">Select Grade</option>
                        <option value="O">O (90-100)</option>
                        <option value="A+">A+ (80-89)</option>
                        <option value="A">A (70-79)</option>
                        <option value="B+">B+ (60-69)</option>
                        <option value="B">B (50-59)</option>
                        <option value="C">C (45-49)</option>
                        <option value="P">P (40-44)</option>
                        <option value="F">F (&lt;40)</option>
                    </select>
                </div>
                <button type="submit" class="btn" style="margin-top:10px;width:100%;"><i class="fas fa-plus"></i> Add Subject</button>
            </form>
        </div>
    </div>
</div>

<div class="notification" id="notification"></div>
<script>
    // --- Data ---
    let subjects = [];
    // --- DOM ---
    const subjectForm = document.getElementById('subjectForm');
    const subjectNameInput = document.getElementById('subjectName');
    const subjectCreditsInput = document.getElementById('subjectCredits');
    const internalMarksInput = document.getElementById('internalMarks');
    const desiredGradeSelect = document.getElementById('desiredGrade');
    const subjectsTableBody = document.getElementById('subjectsTableBody');
    const seeSimTableBody = document.getElementById('seeSimTableBody');
    const desiredSGPAInput = document.getElementById('desiredSGPA');
    const calculateMarksBtn = document.getElementById('calculateMarksBtn');
    const suggestGradesBtn = document.getElementById('suggestGradesBtn');
    const notification = document.getElementById('notification');
    const marksResults = document.getElementById('marksResults');
    const gradeSuggestions = document.getElementById('gradeSuggestions');
    const calcSGPAFromSEE = document.getElementById('calcSGPAFromSEE');
    const sgpaSEEresult = document.getElementById('sgpaSEEresult');
    const calcSGPAFromDesiredGrades = document.getElementById('calcSGPAFromDesiredGrades');
    const desiredGradesSGPAresult = document.getElementById('desiredGradesSGPAresult');
    // New UI elements
    const modal = document.getElementById('addSubjectModal');
    const openModalBtn = document.getElementById('openAddSubjectModalBtn');
    const closeModalBtn = document.getElementById('closeModalBtn');

    // --- Grade Mappings ---
    const gradeToN = {
        "O": 0, "A+": 1, "A": 2, "B+": 3, "B": 4, "C": 5, "P": 6, "F": 10
    };
    const nToGrade = ["O", "A+", "A", "B+", "B", "C", "P", "F"];
    const gradeMinMarks = {
        "O": 90, "A+": 80, "A": 70, "B+": 60, "B": 50, "C": 45, "P": 40, "F": 0
    };

    // --- Notification ---
    function showNotification(message, type) {
        notification.textContent = message;
        notification.className = 'notification';
        notification.classList.add(type, 'show');
        setTimeout(() => notification.classList.remove('show'), 3000);
    }

    // --- Subject Table ---
    function renderSubjectsTable() {
        subjectsTableBody.innerHTML = '';
        if (subjects.length === 0) {
            subjectsTableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No subjects added yet. Click "Add New Subject" to begin.</td></tr>';
            seeSimTableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No subjects added yet</td></tr>';
            return;
        }
        subjects.forEach((subject, idx) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${subject.name}</td>
                <td class="editable-cell" tabindex="0" data-type="credits" data-idx="${idx}">${subject.credits}</td>
                <td class="editable-cell" tabindex="0" data-type="internalMarks" data-idx="${idx}">${subject.internalMarks}/50</td>
                <td class="editable-cell" tabindex="0" data-type="desiredGrade" data-idx="${idx}">${subject.desiredGrade || '-'}</td>
                <td><button class="btn secondary" style="padding:6px 10px;min-width:0;" title="Remove Subject" onclick="removeSubject(${subject.id})"><i class="fas fa-trash"></i></button></td>
            `;
            subjectsTableBody.appendChild(row);
        });
        // Inline editing logic
        subjectsTableBody.querySelectorAll('.editable-cell').forEach(cell => {
            cell.addEventListener('click', handleInlineEdit);
            cell.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    handleInlineEdit.call(this, e);
                }
            });
        });
        renderSEESimTable();
    }
    function handleInlineEdit(e) {
        const cell = e.currentTarget;
        const idx = parseInt(cell.getAttribute('data-idx'));
        const type = cell.getAttribute('data-type');
        const subject = subjects[idx];
        if (!subject) return;
        // Prevent multiple editors
        if (cell.querySelector('input,select')) return;
        let input;
        if (type === 'internalMarks') {
            input = document.createElement('input');
            input.type = 'number';
            input.min = 0;
            input.max = 50;
            input.value = subject.internalMarks;
            input.className = 'inline-edit-input';
        } else if (type === 'credits') {
            input = document.createElement('input');
            input.type = 'number';
            input.min = 1;
            input.max = 5;
            input.value = subject.credits;
            input.className = 'inline-edit-input';
        } else if (type === 'desiredGrade') {
            input = document.createElement('select');
            input.className = 'inline-edit-select';
            ['','O','A+','A','B+','B','C','P','F'].forEach(g => {
                const opt = document.createElement('option');
                opt.value = g;
                opt.textContent = g || '-';
                if (subject.desiredGrade === g) opt.selected = true;
                input.appendChild(opt);
            });
        }
        if (!input) return;
        cell.innerHTML = '';
        cell.appendChild(input);
        input.focus();
        input.addEventListener('blur', () => saveInlineEdit(cell, idx, type, input.value));
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                input.blur();
            } else if (e.key === 'Escape') {
                renderSubjectsTable();
            }
        });
    }
    function saveInlineEdit(cell, idx, type, value) {
        if (type === 'internalMarks') {
            let v = parseInt(value);
            if (isNaN(v) || v < 0) v = 0;
            if (v > 50) v = 50;
            subjects[idx].internalMarks = v;
        } else if (type === 'credits') {
            let v = parseInt(value);
            if (isNaN(v) || v < 1) v = 1;
            if (v > 5) v = 5;
            subjects[idx].credits = v;
        } else if (type === 'desiredGrade') {
            subjects[idx].desiredGrade = value;
        }
        renderSubjectsTable();
    }

    // --- SEE Simulation Table ---
    function renderSEESimTable() {
        seeSimTableBody.innerHTML = '';
        subjects.forEach((subject, idx) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${subject.name}</td>
                <td>${subject.credits}</td>
                <td>${subject.internalMarks}/50</td>
                <td>
                    <input type="number" class="see-input" min="0" max="${subject.credits === 1 ? 50 : 100}" 
                        value="${subject.seeMarks !== undefined ? subject.seeMarks : ''}" 
                        data-idx="${idx}" 
                        placeholder="SEE">
                </td>
                <td id="see-total-${idx}">-</td>
            `;
            seeSimTableBody.appendChild(row);
        });
        // Add event listeners for SEE inputs
        document.querySelectorAll('.see-input').forEach(input => {
            input.addEventListener('input', function() {
                const idx = parseInt(this.getAttribute('data-idx'));
                let val = parseInt(this.value);
                if (isNaN(val) || val < 0) val = 0;
                if (val > (subjects[idx].credits === 1 ? 50 : 100)) val = (subjects[idx].credits === 1 ? 50 : 100);
                subjects[idx].seeMarks = val;
                updateSEETotal(idx);
            });
        });
        // Update totals
        subjects.forEach((_, idx) => updateSEETotal(idx));
    }
    function updateSEETotal(idx) {
        const subject = subjects[idx];
        let see = subject.seeMarks !== undefined ? subject.seeMarks : 0;
        let total;
        if (subject.credits === 1) {
            total = subject.internalMarks + see;
        } else {
            total = subject.internalMarks + Math.round(see / 2);
        }
        document.getElementById(`see-total-${idx}`).textContent = total;
    }

    // --- Edit Subject ---
    window.editSubject = function(id) {
        subjects.forEach(s => s.isEditing = (s.id === id));
        renderSubjectsTable();
    };

    window.cancelEdit = function(id) {
        const subject = subjects.find(s => s.id === id);
        if (subject) {
            subject.isEditing = false;
        }
        renderSubjectsTable();
    };

    window.saveSubject = function(id) {
        const subject = subjects.find(s => s.id === id);
        if (!subject) return;

        const name = document.getElementById(`edit-name-${id}`).value.trim();
        const credits = parseInt(document.getElementById(`edit-credits-${id}`).value);
        const internalMarks = parseInt(document.getElementById(`edit-internals-${id}`).value);
        const desiredGrade = document.getElementById(`edit-grade-${id}`).value;

        if (!name || isNaN(credits) || isNaN(internalMarks)) {
            showNotification('Please fill all required fields with valid values', 'error');
            return;
        }
        if (credits < 1 || credits > 5) {
            showNotification('Credits must be between 1 and 5', 'error');
            return;
        }
        if (internalMarks < 0 || internalMarks > 50) {
            showNotification('Internal marks must be between 0 and 50', 'error');
            return;
        }

        subject.name = name;
        subject.credits = credits;
        subject.internalMarks = internalMarks;
        subject.desiredGrade = desiredGrade;
        subject.isEditing = false;

        showNotification('Subject updated successfully!', 'success');
        renderSubjectsTable();
    };

    // --- Remove Subject ---
    window.removeSubject = function(id) {
        subjects = subjects.filter(subject => subject.id !== id);
        renderSubjectsTable();
        showNotification('Subject removed successfully!', 'success');
    };

    // --- Add Subject ---
    subjectForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const name = subjectNameInput.value.trim();
        const credits = parseInt(subjectCreditsInput.value);
        const internalMarks = parseInt(internalMarksInput.value);
        const desiredGrade = desiredGradeSelect.value;
        if (!name || isNaN(credits) || isNaN(internalMarks)) {
            showNotification('Please fill all required fields with valid values', 'error');
            return;
        }
        if (credits < 1 || credits > 5) {
            showNotification('Credits must be between 1 and 5', 'error');
            return;
        }
        if (internalMarks < 0 || internalMarks > 50) {
            showNotification('Internal marks must be between 0 and 50', 'error');
            return;
        }
        subjects.push({
            id: Date.now() + Math.random(),
            name,
            credits,
            internalMarks,
            desiredGrade,
            isEditing: false
        });
        showNotification('Subject added successfully!', 'success');
        subjectForm.reset();
        modal.style.display = "none"; // Close modal on successful add
        renderSubjectsTable();
        subjectNameInput.focus();
    });

    // --- Calculate Required SEE Marks for Desired Grades ---
    calculateMarksBtn.addEventListener('click', () => {
        marksResults.innerHTML = "";
        if (subjects.length === 0) {
            marksResults.innerHTML = "<span style='color:#e53935;'>Please add at least one subject.</span>";
            return;
        }
        let html = "<strong>Required SEE Marks for Desired Grades:</strong><table style='margin-top:10px;width:100%;'><tr><th>Subject</th><th>Credits</th><th>Desired Grade</th><th>Required Total Marks (out of 100)</th><th>Required SEE</th></tr>";
        subjects.forEach(subj => {
            if (!subj.desiredGrade || !(subj.desiredGrade in gradeToN)) {
                html += `<tr><td>${subj.name}</td><td>${subj.credits}</td><td>-</td><td>-</td><td>-</td></tr>`;
                return;
            }
            const minMarks = gradeMinMarks[subj.desiredGrade];
            let requiredSEE, note = '';
            const maxPossible = subj.internalMarks + (subj.credits === 1 ? 50 : 100);
            if (subj.credits === 1) {
                requiredSEE = minMarks - subj.internalMarks;
                if (minMarks > maxPossible) {
                    note = 'Target not achievable';
                    requiredSEE = 50;
                } else if (requiredSEE < 0) requiredSEE = 0;
            } else {
                requiredSEE = (minMarks - subj.internalMarks) * 2;
                if (minMarks > maxPossible) {
                    note = 'Target not achievable';
                    requiredSEE = 100;
                } else if (requiredSEE < 0) {
                    requiredSEE = 0;
                }
            }
            html += `<tr>
                <td>${subj.name}</td>
                <td>${subj.credits}</td>
                <td>${subj.desiredGrade}</td>
                <td>${minMarks}</td>
                <td>${Math.ceil(requiredSEE)} / ${subj.credits === 1 ? 50 : 100} ${note ? `<span style="color:#e53935;">${note}</span>` : ''}</td>
            </tr>`;
        });
        html += "</table>";
        marksResults.innerHTML = html;
        gradeSuggestions.innerHTML = "";
    });

    // --- Suggest Grade Combinations for Desired SGPA ---
    let gradeSuggestionsList = [];
    let gradeSuggestionIndex = 0;
    function minMarksForGrade(grade) {
        return gradeMinMarks[grade] || 0;
    }
    function suggestGradeCombinationsBalanced(desiredSGPA) {
        const totalCredits = subjects.reduce((sum, s) => sum + s.credits, 0);
        const maxN = 6;
        let suggestions = [];
        function possibleGradesForInternal(internal, credits) {
            let grades = [];
            for (let n = 0; n <= maxN; n++) {
                let grade = nToGrade[n];
                let minMarks = minMarksForGrade(grade);
                let maxSEE = credits === 1 ? 50 : 100;
                let requiredSEE = credits === 1
                    ? minMarks - internal
                    : (minMarks - internal) * 2;
                if (requiredSEE > 0.9 * maxSEE) continue;
                grades.push(n);
            }
            if (grades.length === 0) grades.push(maxN);
            return grades;
        }
        function backtrack(idx, currentCombo, currentDeduction) {
            if (idx === subjects.length) {
                const sgpa = 10 - currentDeduction;
                if (Math.abs(sgpa - desiredSGPA) < 0.05) {
                    suggestions.push([...currentCombo]);
                }
                return;
            }
            let possibleNs = possibleGradesForInternal(subjects[idx].internalMarks, subjects[idx].credits);
            for (let n of possibleNs) {
                const deduction = 0.05 * subjects[idx].credits * n;
                if (10 - (currentDeduction + deduction) < desiredSGPA - 0.05) break;
                currentCombo.push(nToGrade[n]);
                backtrack(idx + 1, currentCombo, currentDeduction + deduction);
                currentCombo.pop();
                if (suggestions.length >= 100) return;
            }
        }
        if (subjects.length > 10) return [];
        backtrack(0, [], 0);
        return suggestions;
    }
    function showCurrentGradeSuggestion() {
        gradeSuggestions.innerHTML = "";
        if (!gradeSuggestionsList.length) {
            gradeSuggestions.innerHTML = `<div class="tool-description" style="color: var(--danger);">No valid grade combinations found for this SGPA. Try a different value.</div>`;
            return;
        }

        const combo = gradeSuggestionsList[gradeSuggestionIndex];
        const chips = combo.map((grade, i) => {
            const subjectName = subjects[i] ? subjects[i].name : 'N/A';
            const gradeClass = grade.replace('+', 'plus');
            return `<div class="grade-chip">
                        <span class="chip-label">${subjectName}:</span>
                        <span class="chip-grade ${gradeClass}">${grade}</span>
                    </div>`;
        }).join("");

        gradeSuggestions.innerHTML = `
            <div class="tool-description" style="margin-bottom: 12px;">
                <i class="fas fa-lightbulb" style="color: var(--primary); margin-right: 7px;"></i>
                <strong>Possible Grade Combination for SGPA ${desiredSGPAInput.value}:</strong>
            </div>
            <div class="grade-chips-row">${chips}</div>
            ${gradeSuggestionsList.length > 1 ? `
                <div style="display: flex; gap: 12px; justify-content: center; align-items: center; margin-top: 20px;">
                    <button id="prevGradeSuggestion" class="btn secondary" style="min-width: 120px;"><i class="fas fa-arrow-left"></i> Previous</button>
                    <span style="font-weight: 600; color: #6c757d; font-size: 0.95rem;">
                        Suggestion ${gradeSuggestionIndex + 1} of ${gradeSuggestionsList.length}
                    </span>
                    <button id="nextGradeSuggestion" class="btn secondary" style="min-width: 120px;"><i class="fas fa-arrow-right"></i> Next</button>
                </div>
            ` : ""}
        `;

        if (gradeSuggestionsList.length > 1) {
            document.getElementById('prevGradeSuggestion').onclick = () => {
                gradeSuggestionIndex = (gradeSuggestionIndex - 1 + gradeSuggestionsList.length) % gradeSuggestionsList.length;
                showCurrentGradeSuggestion();
            };
            document.getElementById('nextGradeSuggestion').onclick = () => {
                gradeSuggestionIndex = (gradeSuggestionIndex + 1) % gradeSuggestionsList.length;
                showCurrentGradeSuggestion();
            };
        }
    }
    suggestGradesBtn.addEventListener('click', () => {
        const desiredSGPA = parseFloat(desiredSGPAInput.value);
        gradeSuggestions.innerHTML = "";
        marksResults.innerHTML = "";
        if (isNaN(desiredSGPA) || desiredSGPA < 0 || desiredSGPA > 10) {
            gradeSuggestions.innerHTML = "<span style='color:#e53935;'>Please enter a valid SGPA between 0 and 10.</span>";
            return;
        }
        if (subjects.length === 0) {
            gradeSuggestions.innerHTML = "<span style='color:#e53935;'>Please add at least one subject.</span>";
            return;
        }
        if (subjects.length > 10) {
            gradeSuggestions.innerHTML = "<span style='color:#e53935;'>Too many subjects for suggestions (max 10 supported).</span>";
            return;
        }
        gradeSuggestionsList = suggestGradeCombinationsBalanced(desiredSGPA);
        gradeSuggestionIndex = 0;
        showCurrentGradeSuggestion();
    });

    // --- Calculate SGPA from SEE Simulation ---
    calcSGPAFromSEE.addEventListener('click', () => {
        if (subjects.length === 0) {
            sgpaSEEresult.style.display = "block";
            sgpaSEEresult.innerHTML = "Please add at least one subject.";
            return;
        }
        let totalCredits = 0;
        let deduction = 0;
        let missing = false;
        subjects.forEach(subj => {
            totalCredits += subj.credits;
            let see = subj.seeMarks !== undefined ? subj.seeMarks : null;
            if (see === null || isNaN(see)) missing = true;
            let total;
            if (subj.credits === 1) {
                total = subj.internalMarks + see;
            } else {
                total = subj.internalMarks + Math.round(see / 2);
            }
            // Determine grade n
            let n = 10; // default fail
            if (total >= 90) n = 0;
            else if (total >= 80) n = 1;
            else if (total >= 70) n = 2;
            else if (total >= 60) n = 3;
            else if (total >= 50) n = 4;
            else if (total >= 45) n = 5;
            else if (total >= 40) n = 6;
            deduction += 0.05 * subj.credits * n;
        });
        if (missing) {
            sgpaSEEresult.style.display = "block";
            sgpaSEEresult.innerHTML = "Please enter SEE marks for all subjects.";
            return;
        }
        let sgpa = 10 - deduction;
        if (sgpa < 0) sgpa = 0;
        if (sgpa > 10) sgpa = 10;
        sgpaSEEresult.style.display = "block";
        sgpaSEEresult.innerHTML = `Your calculated <span style="color:#1565c0;">SGPA</span> is <span style="color:#43a047;">${sgpa.toFixed(2)}</span>`;
    });

    // --- Calculate SGPA from Desired Grades ---
    calcSGPAFromDesiredGrades.addEventListener('click', () => {
        if (subjects.length === 0) {
            desiredGradesSGPAresult.style.display = "block";
            desiredGradesSGPAresult.innerHTML = "Please add at least one subject.";
            return;
        }
        
        let totalCredits = 0;
        let deduction = 0;
        let subjectsWithGrades = 0;
        let gradeBreakdown = [];
        
        subjects.forEach(subj => {
            totalCredits += subj.credits;
            if (subj.desiredGrade && subj.desiredGrade in gradeToN) {
                const n = gradeToN[subj.desiredGrade];
                deduction += 0.05 * subj.credits * n;
                subjectsWithGrades++;
                gradeBreakdown.push({
                    name: subj.name,
                    credits: subj.credits,
                    grade: subj.desiredGrade,
                    n: n,
                    deduction: 0.05 * subj.credits * n
                });
            }
        });
        
        if (subjectsWithGrades === 0) {
            desiredGradesSGPAresult.style.display = "block";
            desiredGradesSGPAresult.innerHTML = "Please set desired grades for at least one subject.";
            return;
        }
        
        let sgpa = 10 - deduction;
        if (sgpa < 0) sgpa = 0;
        if (sgpa > 10) sgpa = 10;
        
        // Create detailed breakdown
        let breakdownHTML = gradeBreakdown.map(item => 
            `<div style="margin: 5px 0; font-size: 0.9em; color: #555;">
                ${item.name} (${item.credits} cr): ${item.grade} → -${item.deduction.toFixed(2)}
            </div>`
        ).join('');
        
        desiredGradesSGPAresult.style.display = "block";
        desiredGradesSGPAresult.innerHTML = `
            <div style="margin-bottom: 10px;">
                <span style="color:#1565c0; font-weight: 600;">SGPA with Desired Grades:</span> 
                <span style="color:#43a047; font-size: 1.2em; font-weight: 700;">${sgpa.toFixed(2)}</span>
            </div>
            <div style="font-size: 0.9em; color: #666; margin-top: 8px;">
                <strong>Breakdown:</strong>
                ${breakdownHTML}
            </div>
        `;
    });

    // --- Modal Logic ---
    openModalBtn.onclick = () => { modal.style.display = "block"; }
    closeModalBtn.onclick = () => { modal.style.display = "none"; }
    window.onclick = (event) => {
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }
    
    // --- Tabs Logic ---
    window.openTool = function(evt, toolName) {
        let i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }
        tablinks = document.getElementsByClassName("tab-link");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" active", "");
        }
        document.getElementById(toolName).style.display = "block";
        evt.currentTarget.className += " active";
    }

    // --- Dark Mode Logic ---
    const darkModeToggle = document.getElementById('darkModeToggle');
    const darkModeText = document.getElementById('darkModeText');
    function setDarkMode(enabled) {
        if (enabled) {
            document.body.classList.add('dark-mode');
            darkModeText.textContent = 'Light Mode';
            darkModeToggle.querySelector('i').classList.remove('fa-moon');
            darkModeToggle.querySelector('i').classList.add('fa-sun');
        } else {
            document.body.classList.remove('dark-mode');
            darkModeText.textContent = 'Dark Mode';
            darkModeToggle.querySelector('i').classList.remove('fa-sun');
            darkModeToggle.querySelector('i').classList.add('fa-moon');
        }
        localStorage.setItem('sgpa_dark_mode', enabled ? '1' : '0');
    }
    darkModeToggle.addEventListener('click', () => {
        setDarkMode(!document.body.classList.contains('dark-mode'));
    });
    // On load, set dark mode if preferred
    document.addEventListener('DOMContentLoaded', () => {
        const darkPref = localStorage.getItem('sgpa_dark_mode');
        if (darkPref === '1' || (darkPref === null && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            setDarkMode(true);
        } else {
            setDarkMode(false);
        }
    });
</script>
</body>
</html>