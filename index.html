<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Engineering SGPA Calculator</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #005fec;
            --primary-dark: #004abc;
            --accent: #27ae60;
            --danger: #e74c3c;
            --bg: #f0f2f5;
            --card-bg: #ffffff;
            --border: #dee2e6;
            --shadow: 0 4px 24px rgba(0, 31, 63, 0.08);
            --radius: 12px;
            --transition: 0.3s ease;
        }
        html {
            scroll-behavior: smooth;
        }
        body {
            background-color: var(--bg);
            background-image:
                linear-gradient(45deg, #e9ecef 25%, transparent 25%),
                linear-gradient(-45deg, #e9ecef 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, #e9ecef 75%),
                linear-gradient(-45deg, transparent 75%, #e9ecef 75%);
            background-size: 20px 20px;
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #343a40;
            margin: 0;
            padding: 0;
        }
        .main-layout {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: #fff;
            padding: 48px 0 32px 0;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 95, 236, 0.1);
        }
        header h1 {
            font-size: 2.8rem;
            font-weight: 700;
            margin-bottom: 12px;
        }
        header p {
            font-size: 1.2rem;
            color: #e9ecef;
            max-width: 700px;
            margin: 0 auto;
        }
        .container {
            max-width: 960px;
            margin: 0 auto;
            padding: 32px 16px;
            flex: 1;
        }
        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid var(--border);
            transition: all var(--transition);
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 32px rgba(0, 31, 63, 0.1);
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }
        .card-title {
            font-size: 1.5rem;
            color: var(--primary);
            font-weight: 700;
            margin: 0;
        }
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }
        .input-group input, 
        .input-group select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            background: #f8f9fa;
            transition: all var(--transition);
            box-sizing: border-box;
        }
        .input-group input:focus, 
        .input-group select:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 95, 236, 0.15);
            background-color: #fff;
        }
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 22px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 4px rgba(0, 95, 236, 0.1);
            letter-spacing: 0.5px;
        }
        .btn:hover, .btn:focus {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 95, 236, 0.2);
        }
        .btn.secondary {
            background: #f1f3f5;
            color: #495057;
            border: 1px solid #dee2e6;
            box-shadow: none;
        }
        .btn.secondary:hover {
            background: #e9ecef;
            color: #212529;
            border-color: #ced4da;
        }
        .table-responsive {
            margin: -16px 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 16px 0;
        }
        th, td {
            padding: 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
        }
        th {
            background-color: #f8f9fa;
            color: #495057;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
        }
        tr:last-child td {
            border-bottom: none;
        }
        tr:hover {
            background-color: #f8f9fa;
        }
        .sgpa-formula {
            margin-top: 18px;
            font-size: 1rem;
            color: #495057;
            background-color: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        .sgpa-formula .formula-note {
            display: block;
            font-size: 0.9em;
            color: #6c757d;
            margin-top: 4px;
        }
        @media (max-width: 768px) {
            .card-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
        }
        
        /* Modal Styles */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1001; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }
        .modal-content {
            background-color: #fff;
            margin: 10% auto;
            padding: 0;
            border: 1px solid #888;
            width: 90%;
            max-width: 500px;
            border-radius: var(--radius);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            animation: slideIn 0.3s;
        }
        .modal-header {
            padding: 16px 24px;
            background-color: var(--primary);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top-left-radius: var(--radius);
            border-top-right-radius: var(--radius);
        }
        .modal-header h2 { margin: 0; font-size: 1.5rem; }
        .modal-body { padding: 24px; display: flex; flex-direction: column; gap: 16px; }
        .close-btn {
            color: white;
            float: right;
            font-size: 28px;
            font-weight: bold;
            background: none;
            border: none;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity var(--transition);
        }
        .close-btn:hover { opacity: 1; }
        @keyframes fadeIn { from {opacity: 0} to {opacity: 1} }
        @keyframes slideIn { from {transform: translateY(-50px)} to {transform: translateY(0)} }
        
        /* Tabs Styles */
        .tools-section { margin-top: 24px; }
        .tabs {
            display: flex;
            gap: 4px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 20px;
        }
        .tab-link {
            padding: 12px 20px;
            cursor: pointer;
            border: none;
            background-color: transparent;
            font-size: 1.05rem;
            font-weight: 600;
            color: #6c757d;
            border-bottom: 3px solid transparent;
            transition: all var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .tab-link:hover {
            color: var(--primary);
            background-color: #f8f9fa;
        }
        .tab-link.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }
        .tab-content { display: none; animation: fadeIn 0.5s; }
        
        .tool-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: flex-end;
            margin-bottom: 20px;
        }
         .tool-controls .input-group {
            flex: 1 1 auto;
            min-width: 120px;
        }
        .tool-result { margin-top: 20px; }
        .tool-description { color: #6c757d; font-size: 1rem; margin: -8px 0 16px 0; }
        .sgpa-result-box {
            background: #e7f5ff;
            color: var(--primary-dark);
        }

        /* Grade Chip Styles */
        .grade-chips-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 12px;
        }
        .grade-chip {
            display: inline-flex;
            align-items: center;
            background-color: #f1f3f5;
            border-radius: 20px;
            padding: 8px 14px;
            font-size: 0.95rem;
            font-weight: 500;
            border: 1px solid var(--border);
            transition: all var(--transition);
        }
        .chip-label {
            color: #495057;
            font-weight: 600;
            margin-right: 8px;
        }
        .chip-grade {
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.9rem;
            color: #fff;
        }
        .chip-grade.O { background-color: #27ae60; }
        .chip-grade.Aplus { background-color: #2980b9; }
        .chip-grade.A { background-color: #3498db; }
        .chip-grade.Bplus { background-color: #f39c12; }
        .chip-grade.B { background-color: #f1c40f; }
        .chip-grade.C { background-color: #e67e22; }
        .chip-grade.P { background-color: #8e44ad; }
        .chip-grade.F { background-color: #c0392b; }
    </style>
</head>
<body>
<div class="main-layout">
    <header>
        <h1><i class="fas fa-graduation-cap"></i> Engineering SGPA Calculator</h1>
        <p>A smart tool to plan your semester, simulate results, and achieve your desired SGPA.</p>
    </header>
    <div class="container">
        <!-- Main Subjects Card -->
        <div class="card" id="main-card">
            <div class="card-header">
                <div class="card-title"><i class="fas fa-list"></i> My Semester Subjects</div>
                <button id="openAddSubjectModalBtn" class="btn"><i class="fas fa-plus"></i> Add New Subject</button>
            </div>
            <div class="table-responsive">
                <table id="subjectsTable">
                    <thead>
                        <tr>
                            <th>Subject Name</th>
                            <th>Credits</th>
                            <th>Internal Marks</th>
                            <th>Desired Grade</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="subjectsTableBody">
                        <!-- Subjects will be added here dynamically -->
                    </tbody>
                </table>
            </div>

            <!-- Tools Section -->
            <div class="tools-section">
                <div class="tabs">
                    <button class="tab-link active" onclick="openTool(event, 'GradePlanner')"><i class="fas fa-bullseye"></i> Grade Planner</button>
                    <button class="tab-link" onclick="openTool(event, 'SEESimulator')"><i class="fas fa-calculator"></i> SEE Simulator</button>
                </div>

                <!-- Grade Planner Tab -->
                <div id="GradePlanner" class="tab-content" style="display: block;">
                    <div class="tool-controls">
                         <div class="input-group">
                            <label for="desiredSGPA">Desired SGPA</label>
                            <input type="number" id="desiredSGPA" min="0" max="10" step="0.01" placeholder="e.g., 8.5" value="8.0">
                        </div>
                        <button id="suggestGradesBtn" class="btn secondary"><i class="fas fa-lightbulb"></i> Suggest Grades</button>
                        <button id="calculateMarksBtn" class="btn secondary"><i class="fas fa-tasks"></i> Required SEE Marks</button>
                        <button id="calcSGPAFromDesiredGrades" class="btn secondary"><i class="fas fa-star"></i> SGPA from Desired</button>
                    </div>
                    <div id="marksResults" class="tool-result"></div>
                    <div id="gradeSuggestions" class="tool-result"></div>
                    <div id="desiredGradesSGPAresult" class="tool-result sgpa-result-box" style="display:none;"></div>
                </div>

                <!-- SEE Simulator Tab -->
                <div id="SEESimulator" class="tab-content">
                    <p class="tool-description">Enter your expected SEE marks for each subject to calculate your final SGPA.</p>
                     <div class="table-responsive">
                        <table id="seeSimTable">
                            <thead>
                                <tr>
                                    <th>Subject Name</th>
                                    <th>Credits</th>
                                    <th>Internal Marks</th>
                                    <th>SEE Marks</th>
                                    <th>Total (100)</th>
                                </tr>
                            </thead>
                            <tbody id="seeSimTableBody">
                                <!-- SEE simulation rows -->
                            </tbody>
                        </table>
                    </div>
                    <div class="tool-controls" style="margin-top: 16px;">
                        <button id="calcSGPAFromSEE" class="btn"><i class="fas fa-equals"></i> Calculate SGPA</button>
                    </div>
                    <div id="sgpaSEEresult" class="tool-result sgpa-result-box" style="display:none;"></div>
                </div>
            </div>
        </div>

        <!-- Grade Info Card -->
        <div class="card" id="grade-info-card">
            <div class="card-title"><i class="fas fa-info-circle"></i> Grade System Info</div>
             <div class="grade-chips-row">
                <div class="grade-chip"><span class="chip-label">O</span><span class="chip-grade O">90-100</span></div>
                <div class="grade-chip"><span class="chip-label">A+</span><span class="chip-grade Aplus">80-89</span></div>
                <div class="grade-chip"><span class="chip-label">A</span><span class="chip-grade A">70-79</span></div>
                <div class="grade-chip"><span class="chip-label">B+</span><span class="chip-grade Bplus">60-69</span></div>
                <div class="grade-chip"><span class="chip-label">B</span><span class="chip-grade B">50-59</span></div>
                <div class="grade-chip"><span class="chip-label">C</span><span class="chip-grade C">45-49</span></div>
                <div class="grade-chip"><span class="chip-label">P</span><span class="chip-grade P">40-44</span></div>
                <div class="grade-chip"><span class="chip-label">F</span><span class="chip-grade F">&lt;40</span></div>
            </div>
            <div class="sgpa-formula">
                <b>SGPA Formula:</b> <span>SGPA = 10 - Σ[(0.05 × credits) × n]</span>
                <span class="formula-note">n is based on grade (O:0, A+:1, A:2, B+:3, B:4, C:5, P:6, F:10)</span>
            </div>
        </div>
    </div>
    <footer>
        <p></p>
    </footer>
</div>

<!-- Add Subject Modal -->
<div id="addSubjectModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-plus-circle"></i> Add New Subject</h2>
            <button id="closeModalBtn" class="close-btn">&times;</button>
        </div>
        <div class="modal-body">
            <form id="subjectForm" autocomplete="off">
                <div class="input-group">
                    <label for="subjectName">Subject Name</label>
                    <input type="text" id="subjectName" placeholder="e.g., Engineering Mathematics" required>
                </div>
                <div class="input-group">
                    <label for="subjectCredits">Credits</label>
                    <input type="number" id="subjectCredits" min="1" max="5" placeholder="e.g., 4" required>
                </div>
                <div class="input-group">
                    <label for="internalMarks">Internal Marks (out of 50)</label>
                    <input type="number" id="internalMarks" min="0" max="50" placeholder="e.g., 38" required>
                </div>
                <div class="input-group">
                    <label for="desiredGrade">Desired Grade (Optional)</label>
                    <select id="desiredGrade">
                        <option value="">Select Grade</option>
                        <option value="O">O (90-100)</option>
                        <option value="A+">A+ (80-89)</option>
                        <option value="A">A (70-79)</option>
                        <option value="B+">B+ (60-69)</option>
                        <option value="B">B (50-59)</option>
                        <option value="C">C (45-49)</option>
                        <option value="P">P (40-44)</option>
                        <option value="F">F (&lt;40)</option>
                    </select>
                </div>
                <button type="submit" class="btn" style="margin-top:10px;width:100%;"><i class="fas fa-plus"></i> Add Subject</button>
            </form>
        </div>
    </div>
</div>

<div class="notification" id="notification"></div>
<script>
    // --- Data ---
    let subjects = [];
    // --- DOM ---
    const subjectForm = document.getElementById('subjectForm');
    const subjectNameInput = document.getElementById('subjectName');
    const subjectCreditsInput = document.getElementById('subjectCredits');
    const internalMarksInput = document.getElementById('internalMarks');
    const desiredGradeSelect = document.getElementById('desiredGrade');
    const subjectsTableBody = document.getElementById('subjectsTableBody');
    const seeSimTableBody = document.getElementById('seeSimTableBody');
    const desiredSGPAInput = document.getElementById('desiredSGPA');
    const calculateMarksBtn = document.getElementById('calculateMarksBtn');
    const suggestGradesBtn = document.getElementById('suggestGradesBtn');
    const notification = document.getElementById('notification');
    const marksResults = document.getElementById('marksResults');
    const gradeSuggestions = document.getElementById('gradeSuggestions');
    const calcSGPAFromSEE = document.getElementById('calcSGPAFromSEE');
    const sgpaSEEresult = document.getElementById('sgpaSEEresult');
    const calcSGPAFromDesiredGrades = document.getElementById('calcSGPAFromDesiredGrades');
    const desiredGradesSGPAresult = document.getElementById('desiredGradesSGPAresult');
    // New UI elements
    const modal = document.getElementById('addSubjectModal');
    const openModalBtn = document.getElementById('openAddSubjectModalBtn');
    const closeModalBtn = document.getElementById('closeModalBtn');

    // --- Grade Mappings ---
    const gradeToN = {
        "O": 0, "A+": 1, "A": 2, "B+": 3, "B": 4, "C": 5, "P": 6, "F": 10
    };
    const nToGrade = ["O", "A+", "A", "B+", "B", "C", "P", "F"];
    const gradeMinMarks = {
        "O": 90, "A+": 80, "A": 70, "B+": 60, "B": 50, "C": 45, "P": 40, "F": 0
    };

    // --- Notification ---
    function showNotification(message, type) {
        notification.textContent = message;
        notification.className = 'notification';
        notification.classList.add(type, 'show');
        setTimeout(() => notification.classList.remove('show'), 3000);
    }

    // --- Subject Table ---
    function renderSubjectsTable() {
        subjectsTableBody.innerHTML = '';
        if (subjects.length === 0) {
            subjectsTableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No subjects added yet. Click "Add New Subject" to begin.</td></tr>';
            seeSimTableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No subjects added yet</td></tr>';
            return;
        }
        subjects.forEach((subject, idx) => {
            const row = document.createElement('tr');
            if (subject.isEditing) {
                row.innerHTML = `
                    <td><input type="text" id="edit-name-${subject.id}" value="${subject.name}" class="see-input" style="width:95%;"></td>
                    <td><input type="number" id="edit-credits-${subject.id}" value="${subject.credits}" min="1" max="5" class="see-input" style="width:60px;"></td>
                    <td><input type="number" id="edit-internals-${subject.id}" value="${subject.internalMarks}" min="0" max="50" class="see-input" style="width:60px;"></td>
                    <td>
                        <select id="edit-grade-${subject.id}" class="see-input" style="width:95%;">
                            <option value="" ${!subject.desiredGrade ? 'selected' : ''}>-</option>
                            <option value="O" ${subject.desiredGrade === 'O' ? 'selected' : ''}>O</option>
                            <option value="A+" ${subject.desiredGrade === 'A+' ? 'selected' : ''}>A+</option>
                            <option value="A" ${subject.desiredGrade === 'A' ? 'selected' : ''}>A</option>
                            <option value="B+" ${subject.desiredGrade === 'B+' ? 'selected' : ''}>B+</option>
                            <option value="B" ${subject.desiredGrade === 'B' ? 'selected' : ''}>B</option>
                            <option value="C" ${subject.desiredGrade === 'C' ? 'selected' : ''}>C</option>
                            <option value="P" ${subject.desiredGrade === 'P' ? 'selected' : ''}>P</option>
                            <option value="F" ${subject.desiredGrade === 'F' ? 'selected' : ''}>F</option>
                        </select>
                    </td>
                    <td>
                        <div style="display:flex; gap: 6px;">
                            <button onclick="saveSubject(${subject.id})" class="btn" style="padding:7px 12px;font-size:0.98em;"><i class="fas fa-save"></i></button>
                            <button onclick="cancelEdit(${subject.id})" class="btn secondary" style="padding:7px 12px;font-size:0.98em;"><i class="fas fa-times"></i></button>
                        </div>
                    </td>
                `;
            } else {
                row.innerHTML = `
                    <td>${subject.name}</td>
                    <td>${subject.credits}</td>
                    <td>${subject.internalMarks}/50</td>
                    <td>${subject.desiredGrade || '-'}</td>
                    <td>
                        <div style="display:flex; gap: 6px;">
                            <button onclick="editSubject(${subject.id})" class="btn secondary" style="padding:7px 12px;font-size:0.98em;"><i class="fas fa-pencil-alt"></i></button>
                            <button onclick="removeSubject(${subject.id})" class="btn secondary" style="padding:7px 12px;font-size:0.98em;"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                `;
            }
            subjectsTableBody.appendChild(row);
        });
        renderSEESimTable();
    }

    // --- SEE Simulation Table ---
    function renderSEESimTable() {
        seeSimTableBody.innerHTML = '';
        subjects.forEach((subject, idx) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${subject.name}</td>
                <td>${subject.credits}</td>
                <td>${subject.internalMarks}/50</td>
                <td>
                    <input type="number" class="see-input" min="0" max="${subject.credits === 1 ? 50 : 100}" 
                        value="${subject.seeMarks !== undefined ? subject.seeMarks : ''}" 
                        data-idx="${idx}" 
                        placeholder="SEE">
                </td>
                <td id="see-total-${idx}">-</td>
            `;
            seeSimTableBody.appendChild(row);
        });
        // Add event listeners for SEE inputs
        document.querySelectorAll('.see-input').forEach(input => {
            input.addEventListener('input', function() {
                const idx = parseInt(this.getAttribute('data-idx'));
                let val = parseInt(this.value);
                if (isNaN(val) || val < 0) val = 0;
                if (val > (subjects[idx].credits === 1 ? 50 : 100)) val = (subjects[idx].credits === 1 ? 50 : 100);
                subjects[idx].seeMarks = val;
                updateSEETotal(idx);
            });
        });
        // Update totals
        subjects.forEach((_, idx) => updateSEETotal(idx));
    }
    function updateSEETotal(idx) {
        const subject = subjects[idx];
        let see = subject.seeMarks !== undefined ? subject.seeMarks : 0;
        let total;
        if (subject.credits === 1) {
            total = subject.internalMarks + see;
        } else {
            total = subject.internalMarks + Math.round(see / 2);
        }
        document.getElementById(`see-total-${idx}`).textContent = total;
    }

    // --- Edit Subject ---
    window.editSubject = function(id) {
        subjects.forEach(s => s.isEditing = (s.id === id));
        renderSubjectsTable();
    };

    window.cancelEdit = function(id) {
        const subject = subjects.find(s => s.id === id);
        if (subject) {
            subject.isEditing = false;
        }
        renderSubjectsTable();
    };

    window.saveSubject = function(id) {
        const subject = subjects.find(s => s.id === id);
        if (!subject) return;

        const name = document.getElementById(`edit-name-${id}`).value.trim();
        const credits = parseInt(document.getElementById(`edit-credits-${id}`).value);
        const internalMarks = parseInt(document.getElementById(`edit-internals-${id}`).value);
        const desiredGrade = document.getElementById(`edit-grade-${id}`).value;

        if (!name || isNaN(credits) || isNaN(internalMarks)) {
            showNotification('Please fill all required fields with valid values', 'error');
            return;
        }
        if (credits < 1 || credits > 5) {
            showNotification('Credits must be between 1 and 5', 'error');
            return;
        }
        if (internalMarks < 0 || internalMarks > 50) {
            showNotification('Internal marks must be between 0 and 50', 'error');
            return;
        }

        subject.name = name;
        subject.credits = credits;
        subject.internalMarks = internalMarks;
        subject.desiredGrade = desiredGrade;
        subject.isEditing = false;

        showNotification('Subject updated successfully!', 'success');
        renderSubjectsTable();
    };

    // --- Remove Subject ---
    window.removeSubject = function(id) {
        subjects = subjects.filter(subject => subject.id !== id);
        renderSubjectsTable();
        showNotification('Subject removed successfully!', 'success');
    };

    // --- Add Subject ---
    subjectForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const name = subjectNameInput.value.trim();
        const credits = parseInt(subjectCreditsInput.value);
        const internalMarks = parseInt(internalMarksInput.value);
        const desiredGrade = desiredGradeSelect.value;
        if (!name || isNaN(credits) || isNaN(internalMarks)) {
            showNotification('Please fill all required fields with valid values', 'error');
            return;
        }
        if (credits < 1 || credits > 5) {
            showNotification('Credits must be between 1 and 5', 'error');
            return;
        }
        if (internalMarks < 0 || internalMarks > 50) {
            showNotification('Internal marks must be between 0 and 50', 'error');
            return;
        }
        subjects.push({
            id: Date.now() + Math.random(),
            name,
            credits,
            internalMarks,
            desiredGrade,
            isEditing: false
        });
        showNotification('Subject added successfully!', 'success');
        subjectForm.reset();
        modal.style.display = "none"; // Close modal on successful add
        renderSubjectsTable();
        subjectNameInput.focus();
    });

    // --- Calculate Required SEE Marks for Desired Grades ---
    calculateMarksBtn.addEventListener('click', () => {
        marksResults.innerHTML = "";
        if (subjects.length === 0) {
            marksResults.innerHTML = "<span style='color:#e53935;'>Please add at least one subject.</span>";
            return;
        }
        let html = "<strong>Required SEE Marks for Desired Grades:</strong><table style='margin-top:10px;width:100%;'><tr><th>Subject</th><th>Credits</th><th>Desired Grade</th><th>Required Total Marks (out of 100)</th><th>Required SEE</th></tr>";
        subjects.forEach(subj => {
            if (!subj.desiredGrade || !(subj.desiredGrade in gradeToN)) {
                html += `<tr><td>${subj.name}</td><td>${subj.credits}</td><td>-</td><td>-</td><td>-</td></tr>`;
                return;
            }
            const minMarks = gradeMinMarks[subj.desiredGrade];
            let requiredSEE, note = '';
            const maxPossible = subj.internalMarks + (subj.credits === 1 ? 50 : 100);
            if (subj.credits === 1) {
                requiredSEE = minMarks - subj.internalMarks;
                if (minMarks > maxPossible) {
                    note = 'Target not achievable';
                    requiredSEE = 50;
                } else if (requiredSEE < 0) requiredSEE = 0;
            } else {
                requiredSEE = (minMarks - subj.internalMarks) * 2;
                if (minMarks > maxPossible) {
                    note = 'Target not achievable';
                    requiredSEE = 100;
                } else if (requiredSEE < 0) {
                    requiredSEE = 0;
                }
            }
            html += `<tr>
                <td>${subj.name}</td>
                <td>${subj.credits}</td>
                <td>${subj.desiredGrade}</td>
                <td>${minMarks}</td>
                <td>${Math.ceil(requiredSEE)} / ${subj.credits === 1 ? 50 : 100} ${note ? `<span style="color:#e53935;">${note}</span>` : ''}</td>
            </tr>`;
        });
        html += "</table>";
        marksResults.innerHTML = html;
        gradeSuggestions.innerHTML = "";
    });

    // --- Suggest Grade Combinations for Desired SGPA ---
    let gradeSuggestionsList = [];
    let gradeSuggestionIndex = 0;
    function minMarksForGrade(grade) {
        return gradeMinMarks[grade] || 0;
    }
    function suggestGradeCombinationsBalanced(desiredSGPA) {
        const totalCredits = subjects.reduce((sum, s) => sum + s.credits, 0);
        const maxN = 6;
        let suggestions = [];
        function possibleGradesForInternal(internal, credits) {
            let grades = [];
            for (let n = 0; n <= maxN; n++) {
                let grade = nToGrade[n];
                let minMarks = minMarksForGrade(grade);
                let maxSEE = credits === 1 ? 50 : 100;
                let requiredSEE = credits === 1
                    ? minMarks - internal
                    : (minMarks - internal) * 2;
                if (requiredSEE > 0.9 * maxSEE) continue;
                grades.push(n);
            }
            if (grades.length === 0) grades.push(maxN);
            return grades;
        }
        function backtrack(idx, currentCombo, currentDeduction) {
            if (idx === subjects.length) {
                const sgpa = 10 - currentDeduction;
                if (Math.abs(sgpa - desiredSGPA) < 0.05) {
                    suggestions.push([...currentCombo]);
                }
                return;
            }
            let possibleNs = possibleGradesForInternal(subjects[idx].internalMarks, subjects[idx].credits);
            for (let n of possibleNs) {
                const deduction = 0.05 * subjects[idx].credits * n;
                if (10 - (currentDeduction + deduction) < desiredSGPA - 0.05) break;
                currentCombo.push(nToGrade[n]);
                backtrack(idx + 1, currentCombo, currentDeduction + deduction);
                currentCombo.pop();
                if (suggestions.length >= 100) return;
            }
        }
        if (subjects.length > 10) return [];
        backtrack(0, [], 0);
        return suggestions;
    }
    function showCurrentGradeSuggestion() {
        gradeSuggestions.innerHTML = "";
        if (!gradeSuggestionsList.length) {
            gradeSuggestions.innerHTML = `<div class="tool-description" style="color: var(--danger);">No valid grade combinations found for this SGPA. Try a different value.</div>`;
            return;
        }

        const combo = gradeSuggestionsList[gradeSuggestionIndex];
        const chips = combo.map((grade, i) => {
            const subjectName = subjects[i] ? subjects[i].name : 'N/A';
            const gradeClass = grade.replace('+', 'plus');
            return `<div class="grade-chip">
                        <span class="chip-label">${subjectName}:</span>
                        <span class="chip-grade ${gradeClass}">${grade}</span>
                    </div>`;
        }).join("");

        gradeSuggestions.innerHTML = `
            <div class="tool-description" style="margin-bottom: 12px;">
                <i class="fas fa-lightbulb" style="color: var(--primary); margin-right: 7px;"></i>
                <strong>Possible Grade Combination for SGPA ${desiredSGPAInput.value}:</strong>
            </div>
            <div class="grade-chips-row">${chips}</div>
            ${gradeSuggestionsList.length > 1 ? `
                <div style="display: flex; gap: 12px; justify-content: center; align-items: center; margin-top: 20px;">
                    <button id="prevGradeSuggestion" class="btn secondary" style="min-width: 120px;"><i class="fas fa-arrow-left"></i> Previous</button>
                    <span style="font-weight: 600; color: #6c757d; font-size: 0.95rem;">
                        Suggestion ${gradeSuggestionIndex + 1} of ${gradeSuggestionsList.length}
                    </span>
                    <button id="nextGradeSuggestion" class="btn secondary" style="min-width: 120px;"><i class="fas fa-arrow-right"></i> Next</button>
                </div>
            ` : ""}
        `;

        if (gradeSuggestionsList.length > 1) {
            document.getElementById('prevGradeSuggestion').onclick = () => {
                gradeSuggestionIndex = (gradeSuggestionIndex - 1 + gradeSuggestionsList.length) % gradeSuggestionsList.length;
                showCurrentGradeSuggestion();
            };
            document.getElementById('nextGradeSuggestion').onclick = () => {
                gradeSuggestionIndex = (gradeSuggestionIndex + 1) % gradeSuggestionsList.length;
                showCurrentGradeSuggestion();
            };
        }
    }
    suggestGradesBtn.addEventListener('click', () => {
        const desiredSGPA = parseFloat(desiredSGPAInput.value);
        gradeSuggestions.innerHTML = "";
        marksResults.innerHTML = "";
        if (isNaN(desiredSGPA) || desiredSGPA < 0 || desiredSGPA > 10) {
            gradeSuggestions.innerHTML = "<span style='color:#e53935;'>Please enter a valid SGPA between 0 and 10.</span>";
            return;
        }
        if (subjects.length === 0) {
            gradeSuggestions.innerHTML = "<span style='color:#e53935;'>Please add at least one subject.</span>";
            return;
        }
        if (subjects.length > 10) {
            gradeSuggestions.innerHTML = "<span style='color:#e53935;'>Too many subjects for suggestions (max 10 supported).</span>";
            return;
        }
        gradeSuggestionsList = suggestGradeCombinationsBalanced(desiredSGPA);
        gradeSuggestionIndex = 0;
        showCurrentGradeSuggestion();
    });

    // --- Calculate SGPA from SEE Simulation ---
    calcSGPAFromSEE.addEventListener('click', () => {
        if (subjects.length === 0) {
            sgpaSEEresult.style.display = "block";
            sgpaSEEresult.innerHTML = "Please add at least one subject.";
            return;
        }
        let totalCredits = 0;
        let deduction = 0;
        let missing = false;
        subjects.forEach(subj => {
            totalCredits += subj.credits;
            let see = subj.seeMarks !== undefined ? subj.seeMarks : null;
            if (see === null || isNaN(see)) missing = true;
            let total;
            if (subj.credits === 1) {
                total = subj.internalMarks + see;
            } else {
                total = subj.internalMarks + Math.round(see / 2);
            }
            // Determine grade n
            let n = 10; // default fail
            if (total >= 90) n = 0;
            else if (total >= 80) n = 1;
            else if (total >= 70) n = 2;
            else if (total >= 60) n = 3;
            else if (total >= 50) n = 4;
            else if (total >= 45) n = 5;
            else if (total >= 40) n = 6;
            deduction += 0.05 * subj.credits * n;
        });
        if (missing) {
            sgpaSEEresult.style.display = "block";
            sgpaSEEresult.innerHTML = "Please enter SEE marks for all subjects.";
            return;
        }
        let sgpa = 10 - deduction;
        if (sgpa < 0) sgpa = 0;
        if (sgpa > 10) sgpa = 10;
        sgpaSEEresult.style.display = "block";
        sgpaSEEresult.innerHTML = `Your calculated <span style="color:#1565c0;">SGPA</span> is <span style="color:#43a047;">${sgpa.toFixed(2)}</span>`;
    });

    // --- Calculate SGPA from Desired Grades ---
    calcSGPAFromDesiredGrades.addEventListener('click', () => {
        if (subjects.length === 0) {
            desiredGradesSGPAresult.style.display = "block";
            desiredGradesSGPAresult.innerHTML = "Please add at least one subject.";
            return;
        }
        
        let totalCredits = 0;
        let deduction = 0;
        let subjectsWithGrades = 0;
        let gradeBreakdown = [];
        
        subjects.forEach(subj => {
            totalCredits += subj.credits;
            if (subj.desiredGrade && subj.desiredGrade in gradeToN) {
                const n = gradeToN[subj.desiredGrade];
                deduction += 0.05 * subj.credits * n;
                subjectsWithGrades++;
                gradeBreakdown.push({
                    name: subj.name,
                    credits: subj.credits,
                    grade: subj.desiredGrade,
                    n: n,
                    deduction: 0.05 * subj.credits * n
                });
            }
        });
        
        if (subjectsWithGrades === 0) {
            desiredGradesSGPAresult.style.display = "block";
            desiredGradesSGPAresult.innerHTML = "Please set desired grades for at least one subject.";
            return;
        }
        
        let sgpa = 10 - deduction;
        if (sgpa < 0) sgpa = 0;
        if (sgpa > 10) sgpa = 10;
        
        // Create detailed breakdown
        let breakdownHTML = gradeBreakdown.map(item => 
            `<div style="margin: 5px 0; font-size: 0.9em; color: #555;">
                ${item.name} (${item.credits} cr): ${item.grade} → -${item.deduction.toFixed(2)}
            </div>`
        ).join('');
        
        desiredGradesSGPAresult.style.display = "block";
        desiredGradesSGPAresult.innerHTML = `
            <div style="margin-bottom: 10px;">
                <span style="color:#1565c0; font-weight: 600;">SGPA with Desired Grades:</span> 
                <span style="color:#43a047; font-size: 1.2em; font-weight: 700;">${sgpa.toFixed(2)}</span>
            </div>
            <div style="font-size: 0.9em; color: #666; margin-top: 8px;">
                <strong>Breakdown:</strong>
                ${breakdownHTML}
            </div>
        `;
    });

    // --- Modal Logic ---
    openModalBtn.onclick = () => { modal.style.display = "block"; }
    closeModalBtn.onclick = () => { modal.style.display = "none"; }
    window.onclick = (event) => {
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }
    
    // --- Tabs Logic ---
    window.openTool = function(evt, toolName) {
        let i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }
        tablinks = document.getElementsByClassName("tab-link");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" active", "");
        }
        document.getElementById(toolName).style.display = "block";
        evt.currentTarget.className += " active";
    }

    // --- Sample Data on Load ---
    document.addEventListener('DOMContentLoaded', () => {
        const sampleSubjects = [
            {name: "Maths", credits: 3, internalMarks: 28, desiredGrade: "B"},
            {name: "Microcontrollers", credits: 4, internalMarks: 40, desiredGrade: "A+"},
            {name: "DAA", credits: 3, internalMarks: 40, desiredGrade: "A+"},
            {name: "DBMS", credits: 3, internalMarks: 36, desiredGrade: "A"},
            {name: "Advanced Java", credits: 3, internalMarks: 30, desiredGrade: "A"},
            {name: "javascript", credits: 1, internalMarks: 32, desiredGrade: "A"},
            {name: "DAA lab", credits: 1, internalMarks: 38, desiredGrade: "A+"},
            {name: "DBMS lab", credits: 1, internalMarks: 38, desiredGrade: "A+"},
            {name: "Adv Java Lab", credits: 1, internalMarks: 49, desiredGrade: "O"}
        ];
        sampleSubjects.forEach(subject => {
            subjects.push({
                id: Date.now() + Math.random(),
                ...subject,
                isEditing: false
            });
        });
        renderSubjectsTable();
    });
</script>
</body>
</html>